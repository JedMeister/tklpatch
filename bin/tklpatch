#!/bin/bash -e
# Copyright (c) 2009 Alon Swartz <alon@turnkeylinux.org> - all rights reserved

fatal() {
    echo "fatal: $@" 1>&2
    exit 1
}

usage() {
cat<<EOF
Syntax: $(basename $0) image.iso patch-dir|patch.tar.gz
Environment variables:

    TKLPATCH_DEBUG       Turn on debugging.
EOF
    exit 1
}

if [[ "$#" != "2" ]]; then
    usage
fi

[ "$(id -u)" != "0" ] && fatal "must be run as root"

isofile=$1
patch=$2

[ -n "$TKLPATCH_DEBUG" ] && set -x

name="$(basename $isofile)"
name="$(echo $name | sed 's/.iso$//')"

rootfs=$name.rootfs
cdroot=$name.cdroot

tklpatch-extract-iso $isofile
tklpatch-apply $rootfs $patch
tklpatch-prepare-cdroot $cdroot $rootfs
tklpatch-geniso $cdroot

# delete temporary rootfs and cdroot unless TKLCONV_DEBUG
[ -z "$TKLPATCH_DEBUG" ] && rm -rf $rootfs
[ -z "$TKLPATCH_DEBUG" ] && rm -rf $cdroot

